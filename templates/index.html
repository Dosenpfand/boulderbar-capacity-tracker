<!DOCTYPE html>
<html>
<head>
    <title>boulderbar Capacity Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-card: #ffffff;
            --text-primary: #1a1a1a;
            --text-secondary: #6c757d;
            --border-color: #dee2e6;
            --accent-color: #007bff;
            --shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            --shadow-hover: 0 4px 16px rgba(0, 0, 0, 0.15);
        }

        [data-theme="dark"] {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-card: #1c2128;
            --text-primary: #e6edf3;
            --text-secondary: #8b949e;
            --border-color: #30363d;
            --accent-color: #58a6ff;
            --shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
            --shadow-hover: 0 4px 16px rgba(0, 0, 0, 0.6);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: var(--bg-card);
            border-bottom: 1px solid var(--border-color);
            box-shadow: var(--shadow);
            margin-bottom: 30px;
            transition: all 0.3s ease;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 25px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        h1 {
            font-size: 2rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-color), #6610f2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: fadeInDown 0.6s ease;
        }

        .theme-toggle {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .theme-toggle:hover {
            background: var(--accent-color);
            color: white;
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        .header-actions {
            display: flex;
            align-items: flex-end;
            gap: 12px;
            flex-wrap: wrap;
        }

        .timeframe-select {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .timeframe-select label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.4px;
        }

        .timeframe-select select {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 10px 12px;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .timeframe-select select:hover,
        .timeframe-select select:focus {
            border-color: var(--accent-color);
            box-shadow: var(--shadow);
            outline: none;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
            animation: fadeIn 0.8s ease;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-hover);
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--accent-color);
        }

        .chart-container {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 25px;
            margin: 20px 0;
            height: 500px;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
            animation: fadeInUp 0.8s ease;
        }

        .chart-container:hover {
            box-shadow: var(--shadow-hover);
        }

        .loading {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        .spinner {
            border: 3px solid var(--border-color);
            border-top: 3px solid var(--accent-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 1.5rem;
            }

            .header-content {
                flex-direction: column;
                align-items: flex-start;
            }

            .header-actions {
                width: 100%;
                justify-content: space-between;
            }

            .chart-container {
                height: 400px;
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <h1>üßó boulderbar Capacity Tracker</h1>
            <div class="header-actions">
                <div class="timeframe-select">
                    <label for="timeframe">Timeframe</label>
                    <select id="timeframe">
                        <option value="6">Last 6 hours</option>
                        <option value="24" selected>Last 24 hours</option>
                        <option value="168">Last 7 days</option>
                        <option value="720">Last 30 days</option>
                        <option value="0">All data</option>
                    </select>
                </div>
                <button class="theme-toggle" onclick="toggleTheme()">
                    <span id="theme-icon">üåô</span>
                    <span id="theme-text">Dark Mode</span>
                </button>
            </div>
        </div>
    </header>

    <div class="container">
        <div id="stats" class="stats-grid"></div>
        <div id="loading" class="loading">
            <div class="spinner"></div>
            Loading capacity data...
        </div>
        <div id="charts"></div>
    </div>

    <script>
        // Theme management
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);

            updateThemeButton(newTheme);

            // Update chart if it exists
            if (window.myChart) {
                updateChartTheme(newTheme);
            }
        }

        function updateThemeButton(theme) {
            const icon = document.getElementById('theme-icon');
            const text = document.getElementById('theme-text');

            if (theme === 'dark') {
                icon.textContent = '‚òÄÔ∏è';
                text.textContent = 'Light Mode';
            } else {
                icon.textContent = 'üåô';
                text.textContent = 'Dark Mode';
            }
        }

        function updateChartTheme(theme) {
            const textColor = theme === 'dark' ? '#e6edf3' : '#1a1a1a';
            const gridColor = theme === 'dark' ? '#30363d' : '#dee2e6';

            window.myChart.options.plugins.title.color = textColor;
            window.myChart.options.plugins.legend.labels.color = textColor;
            window.myChart.options.scales.x.ticks.color = textColor;
            window.myChart.options.scales.y.ticks.color = textColor;
            window.myChart.options.scales.x.title.color = textColor;
            window.myChart.options.scales.y.title.color = textColor;
            window.myChart.options.scales.x.grid.color = gridColor;
            window.myChart.options.scales.y.grid.color = gridColor;
            window.myChart.update();
        }

        // Initialize theme
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);
        updateThemeButton(savedTheme);

        // Color palette for lines
        const colorPalette = [
            '#ff6b6b', '#4ecdc4', '#45b7d1', '#f9ca24', '#6c5ce7',
            '#fd79a8', '#fdcb6e', '#00b894', '#e17055', '#74b9ff'
        ];

        const chartsDiv = document.getElementById('charts');
        const statsDiv = document.getElementById('stats');
        const loadingEl = document.getElementById('loading');
        const timeframeSelect = document.getElementById('timeframe');
        const DEFAULT_HOURS = 24;

        function setLoading(isLoading) {
            loadingEl.style.display = isLoading ? 'block' : 'none';
        }

        function renderEmptyState(message) {
            statsDiv.innerHTML = '';
            chartsDiv.innerHTML = `<div class="loading">${message}</div>`;
        }

        function renderStats(data) {
            const locations = Object.keys(data);
            let totalDataPoints = 0;
            let maxCapacity = 0;
            let totalCapacity = 0;

            for (const values of Object.values(data)) {
                totalDataPoints += values.capacities.length;
                if (values.capacities.length > 0) {
                    const locationMax = Math.max(...values.capacities);
                    const locationSum = values.capacities.reduce((a, b) => a + b, 0);
                    maxCapacity = Math.max(maxCapacity, locationMax);
                    totalCapacity += locationSum;
                }
            }

            const avgCapacity = totalDataPoints > 0 ? Math.round(totalCapacity / totalDataPoints) : 0;

            statsDiv.innerHTML = `
                <div class="stat-card">
                    <div class="stat-label">Locations</div>
                    <div class="stat-value">${locations.length}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Data Points</div>
                    <div class="stat-value">${totalDataPoints}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Max Capacity</div>
                    <div class="stat-value">${maxCapacity}%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Avg Capacity</div>
                    <div class="stat-value">${avgCapacity}%</div>
                </div>
            `;
        }

        function buildDatasets(data, sortedTimestamps) {
            const datasets = [];
            let colorIndex = 0;

            for (const [location, values] of Object.entries(data)) {
                const timestampMap = new Map();
                values.timestamps.forEach((ts, i) => {
                    timestampMap.set(ts, values.capacities[i]);
                });

                const capacityData = sortedTimestamps.map(ts => timestampMap.get(ts) ?? null);

                datasets.push({
                    label: location,
                    data: capacityData,
                    borderColor: colorPalette[colorIndex % colorPalette.length],
                    backgroundColor: colorPalette[colorIndex % colorPalette.length] + '20',
                    borderWidth: 2.5,
                    tension: 0.4,
                    spanGaps: true,
                    pointRadius: 3,
                    pointHoverRadius: 6,
                    pointBackgroundColor: colorPalette[colorIndex % colorPalette.length],
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2
                });
                colorIndex++;
            }

            return datasets;
        }

        function renderChart(sortedTimestamps, datasets) {
            chartsDiv.innerHTML = '';

            const container = document.createElement('div');
            container.className = 'chart-container';

            const canvas = document.createElement('canvas');
            container.appendChild(canvas);
            chartsDiv.appendChild(container);

            const theme = document.documentElement.getAttribute('data-theme');
            const textColor = theme === 'dark' ? '#e6edf3' : '#1a1a1a';
            const gridColor = theme === 'dark' ? '#30363d' : '#dee2e6';

            if (window.myChart) {
                window.myChart.destroy();
            }

            window.myChart = new Chart(canvas, {
                type: 'line',
                data: {
                    labels: sortedTimestamps.map(ts => new Date(ts).toLocaleString()),
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Capacity Over Time',
                            color: textColor,
                            font: {
                                size: 18,
                                weight: 'bold'
                            },
                            padding: 20
                        },
                        legend: {
                            labels: {
                                color: textColor,
                                padding: 15,
                                font: {
                                    size: 12
                                },
                                usePointStyle: true,
                                pointStyle: 'circle'
                            }
                        },
                        tooltip: {
                            backgroundColor: theme === 'dark' ? '#1c2128' : '#ffffff',
                            titleColor: textColor,
                            bodyColor: textColor,
                            borderColor: gridColor,
                            borderWidth: 1,
                            padding: 12,
                            displayColors: true,
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.y + '%';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: textColor,
                                maxRotation: 45,
                                minRotation: 45
                            },
                            grid: {
                                color: gridColor,
                                drawBorder: false
                            },
                            title: {
                                display: true,
                                text: 'Time',
                                color: textColor,
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            }
                        },
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                color: textColor,
                                callback: function(value) {
                                    return value + '%';
                                }
                            },
                            grid: {
                                color: gridColor,
                                drawBorder: false
                            },
                            title: {
                                display: true,
                                text: 'Capacity',
                                color: textColor,
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderDashboard(data) {
            const locations = Object.keys(data);
            if (locations.length === 0) {
                renderEmptyState('No data available for this timeframe.');
                return;
            }

            renderStats(data);

            const allTimestamps = new Set();
            for (const values of Object.values(data)) {
                values.timestamps.forEach(ts => allTimestamps.add(ts));
            }

            const sortedTimestamps = Array.from(allTimestamps).sort();
            const datasets = buildDatasets(data, sortedTimestamps);

            renderChart(sortedTimestamps, datasets);
        }

        function buildRequestUrl(hours) {
            const params = new URLSearchParams({ hours: String(hours) });
            return `/api/data?${params.toString()}`;
        }

        function fetchData(hours) {
            setLoading(true);

            fetch(buildRequestUrl(hours))
                .then(response => response.json())
                .then(data => {
                    setLoading(false);
                    renderDashboard(data);
                })
                .catch(error => {
                    setLoading(false);
                    renderEmptyState(`Error loading data: ${error.message}`);
                });
        }

        timeframeSelect.addEventListener('change', () => {
            fetchData(timeframeSelect.value);
        });

        fetchData(DEFAULT_HOURS);
    </script>
</body>
</html>
